<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EV Charging Demo Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.2em;
      margin-bottom: 10px;
    }

    .dashboard {
      padding: 30px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      border-left: 4px solid #2a5298;
    }

    .stat-value {
      font-size: 2em;
      font-weight: bold;
      color: #2a5298;
    }

    .stat-label {
      color: #666;
      margin-top: 5px;
      font-size: 0.9em;
    }

    .section-title {
      font-size: 1.4em;
      color: #333;
      margin-bottom: 20px;
      border-bottom: 2px solid #2a5298;
      padding-bottom: 10px;
    }

    .charge-points-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .charge-point-card {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .cp-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .cp-id {
      font-weight: bold;
      color: #333;
    }

    .cp-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: bold;
    }

    .status-available {
      background: #d4edda;
      color: #155724;
    }

    .status-charging {
      background: #fff3cd;
      color: #856404;
    }

    .status-occupied {
      background: #f8d7da;
      color: #721c24;
    }

    .status-faulted {
      background: #f5c6cb;
      color: #721c24;
    }

    .cp-details {
      font-size: 0.9em;
      color: #666;
    }

    .cp-detail {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .sessions-table {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #ddd;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f8f9fa;
      font-weight: bold;
    }

    .refresh-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: #2a5298;
      color: white;
      border: none;
      border-radius: 50px;
      padding: 15px 20px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(42, 82, 152, 0.3);
      font-size: 14px;
    }

    .refresh-btn:hover {
      background: #1e3c72;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .demo-controls {
      background: #e9ecef;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      text-align: center;
    }

    .demo-btn {
      background: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px 15px;
      margin: 5px;
      cursor: pointer;
      font-size: 0.9em;
    }

    .demo-btn:hover {
      background: #218838;
    }

    .demo-btn.danger {
      background: #dc3545;
    }

    .demo-btn.danger:hover {
      background: #c82333;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>âš¡ EV Charging Management System</h1>
      <p>AWS Serverless Demo Dashboard</p>
    </div>

    <div class="dashboard">
      <div id="error-message"></div>

      <!-- Demo Controls -->
      <div class="demo-controls">
        <h3 style="margin-bottom: 15px;">Demo Controls</h3>
        <button class="demo-btn" onclick="triggerSimulation()">Trigger Simulation</button>
        <button class="demo-btn" onclick="refreshData()">Refresh Data</button>
        <span style="margin-left: 20px; color: #666;">
          Auto-refresh: <span id="auto-status">ON</span>
        </span>
      </div>

      <!-- Statistics -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalChargePoints">-</div>
          <div class="stat-label">Total Charge Points</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="availableChargePoints">-</div>
          <div class="stat-label">Available</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="chargingChargePoints">-</div>
          <div class="stat-label">Charging</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="activeSessions">-</div>
          <div class="stat-label">Active Sessions</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalEnergy">-</div>
          <div class="stat-label">Total Energy (kWh)</div>
        </div>
      </div>

      <!-- Charge Points Status -->
      <div class="charge-points-section">
        <h2 class="section-title">ðŸ”Œ Charge Points Status</h2>
        <div class="charge-points-grid" id="chargePointsGrid">
          <div class="loading">Loading charge points...</div>
        </div>
      </div>

      <!-- Recent Sessions -->
      <div class="sessions-section">
        <h2 class="section-title">ðŸ“Š Charging Sessions</h2>
        <div class="sessions-table">
          <table>
            <thead>
              <tr>
                <th>Session ID</th>
                <th>Charge Point</th>
                <th>Status</th>
                <th>Energy (kWh)</th>
                <th>Cost ($)</th>
                <th>Start Time</th>
              </tr>
            </thead>
            <tbody id="sessionsTableBody">
              <tr>
                <td colspan="6" class="loading">Loading sessions...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <button class="refresh-btn" onclick="refreshData()">ðŸ”„ Refresh</button>

  <script>
    // Configuration - REPLACE THIS WITH YOUR API ENDPOINT
    const API_ENDPOINT = 'https://3tgegmp6bg.execute-api.eu-west-2.amazonaws.com/prod';

    let autoRefresh = true;
    let refreshInterval;

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function () {
      if (API_ENDPOINT === 'API_ENDPOINT_HERE') {
        showError('API endpoint not configured. Please update the API_ENDPOINT variable in the HTML file.');
        return;
      }

      refreshData();
      startAutoRefresh();
    });

    function showError(message) {
      document.getElementById('error-message').innerHTML =
        `<div class="error">Error: ${message}</div>`;
    }

    function clearError() {
      document.getElementById('error-message').innerHTML = '';
    }

    async function refreshData() {
      clearError();

      try {
        await Promise.all([
          loadStats(),
          loadChargePoints(),
          loadSessions()
        ]);
        console.log('Dashboard refreshed successfully');
      } catch (error) {
        console.error('Error refreshing dashboard:', error);
        showError('Failed to load data from API. Check console for details.');
      }
    }

    async function loadStats() {
      try {
        const response = await fetch(`${API_ENDPOINT}/stats`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const stats = await response.json();

        document.getElementById('totalChargePoints').textContent = stats.totalChargePoints || 0;
        document.getElementById('availableChargePoints').textContent = stats.availableChargePoints || 0;
        document.getElementById('chargingChargePoints').textContent = stats.chargingChargePoints || 0;
        document.getElementById('activeSessions').textContent = stats.activeSessions || 0;
        document.getElementById('totalEnergy').textContent = (stats.totalEnergy || 0).toFixed(1);
      } catch (error) {
        console.error('Error loading stats:', error);
        throw error;
      }
    }

    async function loadChargePoints() {
      try {
        const response = await fetch(`${API_ENDPOINT}/chargepoints`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const chargePoints = await response.json();
        const grid = document.getElementById('chargePointsGrid');

        if (chargePoints.length === 0) {
          grid.innerHTML = '<div class="loading">No charge points found. Trigger simulation to create demo data.</div>';
          return;
        }

        grid.innerHTML = chargePoints.map(cp => `
                    <div class="charge-point-card">
                        <div class="cp-header">
                            <div class="cp-id">${cp.chargePointId}</div>
                            <div class="cp-status status-${(cp.status || 'unknown').toLowerCase()}">${cp.status || 'Unknown'}</div>
                        </div>
                        <div class="cp-details">
                            <div class="cp-detail">
                                <span>Location:</span>
                                <span>${cp.location || 'Unknown'}</span>
                            </div>
                            <div class="cp-detail">
                                <span>Model:</span>
                                <span>${cp.model || 'Unknown'}</span>
                            </div>
                            <div class="cp-detail">
                                <span>Max Power:</span>
                                <span>${cp.maxPower || 0} kW</span>
                            </div>
                            <div class="cp-detail">
                                <span>Last Seen:</span>
                                <span>${formatTime(cp.lastSeen)}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
      } catch (error) {
        console.error('Error loading charge points:', error);
        throw error;
      }
    }

    async function loadSessions() {
      try {
        const response = await fetch(`${API_ENDPOINT}/sessions`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const sessions = await response.json();
        const tbody = document.getElementById('sessionsTableBody');

        if (sessions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="loading">No sessions found</td></tr>';
          return;
        }

        tbody.innerHTML = sessions.slice(0, 10).map(session => `
                    <tr>
                        <td>${(session.sessionId || '').substring(0, 8)}...</td>
                        <td>${session.chargePointId || ''}</td>
                        <td><span class="cp-status status-${(session.status || 'unknown').toLowerCase()}">${session.status || 'Unknown'}</span></td>
                        <td>${(session.currentEnergy || 0).toFixed(1)}</td>
                        <td>${(session.cost || 0).toFixed(2)}</td>
                        <td>${formatTime(session.startTime)}</td>
                    </tr>
                `).join('');
      } catch (error) {
        console.error('Error loading sessions:', error);
        throw error;
      }
    }

    async function triggerSimulation() {
      try {
        const lambdaName = 'demo-simulator'; // This should match your Lambda function name

        // For demo purposes, we'll just refresh the data
        // In a real implementation, you would invoke the Lambda function
        showError('Simulation triggered! Data will refresh automatically.');
        setTimeout(() => {
          clearError();
          refreshData();
        }, 2000);

      } catch (error) {
        console.error('Error triggering simulation:', error);
        showError('Failed to trigger simulation');
      }
    }

    function formatTime(isoString) {
      if (!isoString) return 'Unknown';

      const date = new Date(isoString);
      const now = new Date();
      const diffMinutes = Math.floor((now - date) / 60000);

      if (diffMinutes < 1) return 'Just now';
      if (diffMinutes < 60) return `${diffMinutes}m ago`;
      if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)}h ago`;
      return date.toLocaleDateString();
    }

    function startAutoRefresh() {
      if (refreshInterval) clearInterval(refreshInterval);

      refreshInterval = setInterval(() => {
        if (autoRefresh) {
          refreshData();
        }
      }, 30000); // Refresh every 30 seconds
    }

    function toggleAutoRefresh() {
      autoRefresh = !autoRefresh;
      document.getElementById('auto-status').textContent = autoRefresh ? 'ON' : 'OFF';
    }

    // Handle API endpoint configuration check
    if (API_ENDPOINT === 'API_ENDPOINT_HERE') {
      console.warn('API endpoint not configured. Please update the API_ENDPOINT variable.');
    }
  </script>
</body>

</html>